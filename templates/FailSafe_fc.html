<!DOCTYPE html>

<html lang="en" data-bs-theme="light">
<head>
	<meta charset="utf-8">
	<title>FailSafe | Fact-checking</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	
	<!-- ================== BEGIN core-css ================== -->
    <link href="{{ url_for('static', filename='css/vendor.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/app.min.css') }}" rel="stylesheet">
	<!-- ================== END core-css ================== -->
	
	<!-- ================== BEGIN page-css ================== -->
    <link href="{{ url_for('static', filename='css/factcheck.css') }}" rel="stylesheet">
	<!-- ================== END page-css ================== -->

    <!-- START: Thêm code cho SAG -->
    <!-- Tải thư viện Vis.js để vẽ đồ thị -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- CSS để định dạng khung vẽ đồ thị -->
    <style type="text/css">
      #sag-graph {
        width: 100%;
        height: 450px; /* Tăng chiều cao một chút */
        border: 1px solid #e5e5e5;
        background-color: #fbfbfb;
      }
    </style>
    <!-- END: Thêm code cho SAG -->

</head>
<body class="theme-gray-100">

	<!-- BEGIN #app -->
	<div id="app" class="app app-without-sidebar" >
        <!-- BEGIN #header -->
        <div id="header" class="app-header">
                <div class="brand">
                    <a href="/" class="brand-logo"> <!-- Sửa link về trang chủ -->
                        <span>
                        <img src="{{ url_for('static', filename='amin_amin.png') }}" alt="logo" height="20">
                        </span>
                        <span class="brand-text">  FAILSAFE  </span>
                    </a>
        
                </div>
                <div class="menu">
                    <div class="menu-item dropdown dropdown-mobile-full">
                        <a href="#" data-bs-toggle="dropdown" data-bs-display="static" class="menu-link">
                            <div class="menu-img online">
                                <img src="{{ url_for('static', filename='XH.jpeg') }}" alt="Profile" height="60">
                            </div>
                            <div class="menu-text d-sm-block d-none w-170px">minhdinhkhoi@gmail.com</div>
                        </a>
                    </div>
                
                </div>
            </div>
		<!-- END #header -->

		<!-- BEGIN #content -->
		<div id="content" class="app-content" >
			<ul class="breadcrumb">
				<li class="breadcrumb-item"><a href="#">Amin</a></li>
				<li class="breadcrumb-item active">Fact-checking</li>
			</ul>
            <div class="row">
                <div class="col-xl-4">
                    <div class="card">
                        <div class="card-body">
                            {% if responses['claim_detail'] %}
                                <div>
                                    <!-- Hiển thị các claim đã được trích xuất -->
                                    {% for claim_detail in responses['claim_detail'] %}
                                        <sup>{{ loop.index }}</sup>
                                        {% if claim_detail['factuality'] is number and claim_detail['factuality'] <= 0.25 %}
                                            <span class="refutes-span" data-claim-index="{{ loop.index }}">
                                        {% elif claim_detail['factuality'] is number and claim_detail['factuality'] >= 0.75 %}
                                            <span class="support-span" data-claim-index="{{ loop.index }}">
                                        {% elif claim_detail['factuality'] == 'Nothing to check' or claim_detail['factuality'] == 'No evidence found' %}
                                            <span class="neutral-span">
                                        {% else %}
                                            <span class="controversial-span" data-claim-index="{{ loop.index }}">
                                        {% endif %}
                                            <span class="fs-4">
                                                {{ claim_detail['origin_text'] }}
                                            </span>
                                        </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <!-- Hiển thị văn bản gốc nếu không có claim nào được phân rã -->
                                <p class="fs-4">{{ responses['raw_text'] }}</p>
                            {% endif %}
                        </div>
                        <div class="card-arrow">
                            <div class="card-arrow-top-left"></div>
                            <div class="card-arrow-top-right"></div>
                            <div class="card-arrow-bottom-left"></div>
                            <div class="card-arrow-bottom-right"></div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-5">
                    {% if responses['claim_detail'] %}
                        <div class="card">
                            <div class="card-header">
                                <h6>
                                    <strong>Claim:&nbsp;</strong> {{ responses['claim_detail'][shown_claim]["claim"] }}
                                </h6>
                                <h6 class="card-title">
                                    Evidences <span class="badge bg-danger">{{ responses['claim_detail'][shown_claim]["evidences"] | length }}</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-pills mb-3" id="pills-tab">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="pills-refutes-tab" data-bs-toggle="pill" href="#pills-refutes">
                                            <p class="text-danger">REFUTES ({{ responses['claim_detail'][shown_claim]["evidences"] | count_occurrences("REFUTES", "relationship") }})</p>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="pills-contextualizes-tab" data-bs-toggle="pill" href="#pills-contextualizes">
                                            <p class="text-warning">IRRELEVANT ({{ responses['claim_detail'][shown_claim]["evidences"] | count_occurrences("IRRELEVANT", "relationship") }})</p>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="pills-supports-tab" data-bs-toggle="pill" href="#pills-supports">
                                            <p class="text-success">SUPPORTS ({{ responses['claim_detail'][shown_claim]["evidences"] | count_occurrences("SUPPORTS", "relationship") }})</p>
                                        </a>
                                    </li>
                                </ul>
                                <div class="tab-content" id="pills-tabContent">
                                    <div class="tab-pane fade show active" id="pills-refutes">
                                        <div class="accordion" id="accordionRefutes">
                                            {% for evi in responses['claim_detail'][shown_claim]["evidences"] | filter_evidences("REFUTES", "relationship")  %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="headingRef{{ loop.index }}">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRefutes{{ loop.index }}">
                                                        <p class="text-danger">
                                                            REFUTES - {{ loop.index }}
                                                        </p>
                                                    </button>
                                                </h2>
                                                <div id="collapseRefutes{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionRefutes">
                                                    <div class="accordion-body">
                                                        <p><strong>Evidence:&nbsp;</strong>{{ evi["text"] }}</p>
                                                        <p><strong>Source:&nbsp;</strong><span class="evidence-text pre-wrap">{{ evi.url }}</span></p>
                                                        <p><strong>Reasoning:&nbsp;</strong>{{ evi.reasoning }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="pills-contextualizes">
                                        <div class="accordion" id="accordionContextualizes">
                                            {% for evi in responses['claim_detail'][shown_claim]["evidences"] | filter_evidences("IRRELEVANT", "relationship")  %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="headingContext{{ loop.index }}">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContextualizes{{ loop.index }}">
                                                        <p class="text-warning">
                                                            IRRELEVANT - {{ loop.index }}
                                                        </p>
                                                    </button>
                                                </h2>
                                                <div id="collapseContextualizes{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionContextualizes">
                                                    <div class="accordion-body">
                                                        <p><strong>Evidence:&nbsp;</strong>{{ evi["text"] }}</p>
                                                        <p><strong>Source:&nbsp;</strong><span class="evidence-text pre-wrap">{{ evi.url }}</span></p>
                                                        <p><strong>Reasoning:&nbsp;</strong>{{ evi.reasoning }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="pills-supports">
                                        <div class="accordion" id="accordionSupports">
                                            {% for evi in responses['claim_detail'][shown_claim]["evidences"] | filter_evidences("SUPPORTS", "relationship")  %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="headingSupport{{ loop.index }}">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSupports{{ loop.index }}">
                                                        <p class="text-success">
                                                            SUPPORTS - {{ loop.index }}
                                                        </p>
                                                    </button>
                                                </h2>
                                                <div id="collapseSupports{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionSupports">
                                                    <div class="accordion-body">
                                                        <p><strong>Evidence:&nbsp;</strong>{{ evi["text"] }}</p>
                                                        <p><strong>Source:&nbsp;</strong><span class="evidence-text pre-wrap">{{ evi.url }}</span></p>
                                                        <p><strong>Reasoning:&nbsp;</strong>{{ evi.reasoning }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-arrow">
                                <div class="card-arrow-top-left"></div>
                                <div class="card-arrow-top-right"></div>
                                <div class="card-arrow-bottom-left"></div>
                                <div class="card-arrow-bottom-right"></div>
                            </div>
                        </div>
                    {% else %}
                        <div class="card">
                             <div class="card-body text-center">
                                <h5 class="card-title mt-2">No Verifiable Claims Found</h5>
                                <p class="card-text">
                                    The system did not find any factual claims to verify in the provided text.
                                </p>
                                <p class="text-muted">
                                    This could be because the text is an opinion, a question, or too ambiguous.
                                </p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="col-xl-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="card m-1">
                                <div class="card-header">
                                    <h6 class="card-title">
                                        Overall Factuality
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if responses["summary"]["factuality"] is number %}
                                        {{ (responses["summary"]["factuality"] * 100) | round(2) }}%
                                    {% else %}
                                        {{ responses["summary"]["factuality"] }}
                                    {% endif %}
                                </div>
                                <div class="card-arrow">
                                    <div class="card-arrow-top-left"></div>
                                    <div class="card-arrow-top-right"></div>
                                    <div class="card-arrow-bottom-left"></div>
                                    <div class="card-arrow-bottom-right"></div>
                                </div>
                            </div>
                            <div class="card m-1">
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">
                                            <div><h6>{{ responses["summary"]["num_claims"] }}</h6></div>
                                            <div><h7>Detected claims</h7></div>
                                        </li>
                                        <li class="list-group-item">
                                            <div><h6><p class="text-success-emphasis">{{ responses["summary"]["num_supported_claims"] }}</p></h6></div>
                                            <div><h7>Well Supported</h7></div>
                                        </li>
                                        <li class="list-group-item">
                                            <div><h6><p class="text-danger-emphasis">{{ responses["summary"]["num_refuted_claims"] }}</p></h6></div>
                                            <div><h7>Conflict</h7></div>
                                        </li>
                                        <li class="list-group-item">
                                            <div><h6><p class="text-warning">{{ responses["summary"]["num_controversial_claims"] }}</p></h6></div>
                                            <div><h7>Controversial</h7></div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-arrow">
                                    <div class="card-arrow-top-left"></div>
                                    <div class="card-arrow-top-right"></div>
                                    <div class="card-arrow-bottom-left"></div>
                                    <div class="card-arrow-bottom-right"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-arrow">
                            <div class="card-arrow-top-left"></div>
                            <div class="card-arrow-top-right"></div>
                            <div class="card-arrow-bottom-left"></div>
                            <div class="card-arrow-bottom-right"></div>
                        </div>
                    </div>
                    
                    <!-- START: Thêm card mới cho SAG -->
                    <div class="card mt-4"> <!-- Thêm khoảng cách mt-4 -->
                        <div class="card-header">
                            <h6 class="card-title">
                                Argumentation Graph (SAG)
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <!-- Đây là nơi đồ thị sẽ được vẽ -->
                            <div id="sag-graph"></div>
                        </div>
                        <div class="card-arrow">
                            <div class="card-arrow-top-left"></div>
                            <div class="card-arrow-top-right"></div>
                            <div class="card-arrow-bottom-left"></div>
                            <div class="card-arrow-bottom-right"></div>
                        </div>
                    </div>
                    <!-- END: Thêm card mới cho SAG -->

                </div>
            </div>
	</div>
	<!-- END #content -->
		
	<a href="#" data-toggle="scroll-to-top" class="btn-scroll-top fade"><i class="fa fa-arrow-up"></i></a>
		
	<script>
        document.addEventListener('DOMContentLoaded', (event) => {
          document.querySelectorAll('.evidence-text').forEach((element) => {
            if (element.innerHTML.trim() !== '') {
                element.innerHTML = convertUrlsToLinks(element.innerHTML);
            }
          });
          document.querySelectorAll('[data-claim-index]').forEach((el) => {
            el.addEventListener('click', () => {
              const id = Number(el.getAttribute('data-claim-index'));
              if (!Number.isNaN(id)) {
                switchClaim(id);
              }
            });
          });
        });
        function convertUrlsToLinks (text) {
          const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
          return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        }
        function switchClaim (id) {
          window.location.href = "/shownClaim/" + id;
        }
    </script>
	<!-- ================== BEGIN core-js ================== -->
	<script src="{{ url_for('static', filename='/js/vendor.min.js') }}"></script>
	<script src="{{ url_for('static', filename='/js/app.min.js') }}"></script>
	<!-- ================== END core-js ================== -->

    <!-- START: Thêm JavaScript để vẽ SAG -->
    <script type="text/javascript">
        // Sử dụng event listener để đảm bảo trang đã tải xong
        document.addEventListener('DOMContentLoaded', function () {
            // Lấy dữ liệu SAG từ đối tượng 'responses' được truyền từ Flask
            // `| tojson` là một filter của Jinja2 để chuyển đối tượng Python thành chuỗi JSON an toàn
            const sagData = {{responses.sag|tojson}};
    
            // Chỉ chạy code nếu có dữ liệu SAG và có ít nhất 1 node
            if (sagData && sagData.nodes && sagData.nodes.length > 0) {
                // Chuyển đổi dữ liệu nodes từ format của chúng ta sang format của vis-network
                const nodes = new vis.DataSet(sagData.nodes.map(n => ({
                    id: n.id,
                    label: `[${n.id}] ${n.label}`, // Hiển thị cả ID và nội dung
                    title: n.label, // Tooltip khi di chuột qua
                    shape: n.type === 'Claim' ? 'box' : 'ellipse', // Hình hộp cho Claim, tròn cho Entity
                    font: { size: 12 }
                })));
    
                // Chuyển đổi dữ liệu edges
                const edges = new vis.DataSet(sagData.edges.map(e => ({
                    from: e.source,
                    to: e.target,
                    label: e.label,
                    arrows: 'to', // Hiển thị mũi tên
                    color: { // Tô màu cạnh dựa trên loại quan hệ
                        color: e.label.toLowerCase() === 'attacks' ? '#dc3545' : (e.label.toLowerCase() === 'supports' ? '#198754' : '#6c757d'),
                        highlight: e.label.toLowerCase() === 'attacks' ? '#dc3545' : (e.label.toLowerCase() === 'supports' ? '#198754' : '#6c757d')
                    },
                    font: { align: 'middle', size: 11, strokeWidth: 3, strokeColor: '#ffffff' } // Thêm nền trắng cho text
                })));
    
                // Lấy thẻ div làm "khung tranh"
                const container = document.getElementById('sag-graph');
                const data = { nodes: nodes, edges: edges };
                
                // Các tùy chọn cấu hình cho đồ thị
                const options = {
                    layout: {
                        hierarchical: {
                            enabled: true,
                            levelSeparation: 150,
                            nodeSpacing: 120,
                            treeSpacing: 200,
                            direction: 'UD', // Sắp xếp từ trên xuống (Up-Down)
                            sortMethod: 'directed'
                        }
                    },
                    physics: {
                        enabled: false // Tắt hiệu ứng vật lý để đồ thị ổn định
                    },
                    interaction: {
                        dragNodes: true,
                        zoomView: true,
                        dragView: true
                    },
                    nodes: {
                        borderWidth: 1,
                        color: {
                            border: '#4871b7',
                            background: '#d2e5ff',
                        }
                    }
                };
    
                // Khởi tạo và vẽ đồ thị
                const network = new vis.Network(container, data, options);
            }
        });
    </script>
    <!-- END: Thêm JavaScript để vẽ SAG -->

</body></html>