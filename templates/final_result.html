<!DOCTYPE html>

<html lang="en" data-bs-theme="light">
<head>
	<meta charset="utf-8">
	<title>FailSafe | Fact-checking Result</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Fact-checking result page for FailSafe AI">
	<meta name="author" content="FailSafe Team">
	
    <link href="{{ url_for('static', filename='css/vendor.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/app.min.css') }}" rel="stylesheet">

    <link href="{{ url_for('static', filename='css/factcheck.css') }}" rel="stylesheet">

    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="theme-gray-100">

	<div id="app" class="app app-without-sidebar" >
        <div id="header" class="app-header">
            <div class="brand">
                <a href="/" class="brand-logo">
                    <span>
                    <img src="{{ url_for('static', filename='amin_amin.png') }}" alt="logo" height="20">
                    </span>
                    <span class="brand-text">  FAILSAFE  </span>
                </a>
            </div>
            <div class="menu">
                <div class="menu-item dropdown dropdown-mobile-full">
                    <a href="#" data-bs-toggle="dropdown" data-bs-display="static" class="menu-link">
                        <div class="menu-img online">
                            <img src="{{ url_for('static', filename='XH.jpeg') }}" alt="Profile" height="60">
                        </div>
                        <div class="menu-text d-sm-block d-none w-170px">minhdinhkhoi@gmail.com</div>
                    </a>
                </div>
            </div>
        </div>

		<div id="content" class="app-content" >
			<ul class="breadcrumb">
				<li class="breadcrumb-item"><a href="/">Amin</a></li>
				<li class="breadcrumb-item active">Fact-checking</li>
			</ul>
            <div class="row">
                <div class="col-xl-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Original Text</h5>
                            {% if responses['claim_detail'] %}
                                <div>
                                    {% for claim in responses.claim_detail %}
                                        {% set factuality = claim.factuality %}
                                        {% set span_class = 'neutral-span' %} {# Mặc định là màu trung tính #}
                                        
                                        {# Logic tô màu không đổi #}
                                        {% if factuality is number and factuality <= 0.25 %}
                                            {% set span_class = 'refutes-span' %}
                                        {% elif factuality is number and factuality >= 0.75 %}
                                            {% set span_class = 'support-span' %}
                                        {% elif factuality is number %}
                                            {% set span_class = 'controversial-span' %}
                                        {% endif %}
                                        <span 
                                            class="{{ span_class }} claim-interactive {% if loop.index0 == shown_claim %}active{% endif %}" 
                                            data-claim-index="{{ loop.index }}">
                                            <sup>{{ loop.index }}</sup> {{ claim.claim }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p>{{ responses.raw_text }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-xl-5">
                    {% if responses.final_report %}
                    <div class="card mb-3 border-theme">
                        <div class="card-header fw-bold bg-light">
                            <i class="fa fa-file-text me-2"></i> INVESTIGATION REPORT
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            <div id="final-report-content"></div>
                        </div>
                    </div>
                    {% endif %}
                    {% if responses['claim_detail'] %}
                        {% set active_claim = responses.claim_detail[shown_claim] %}
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title">Claim #{{ active_claim.id }}: {{ active_claim.claim }}</h5>
                                        <p class="card-subtitle text-muted">{{ active_claim.checkworthy_reason }}</p>
                                    </div>
                                    <div style="height: 80px; width: 80px;">
                                        <canvas id="chart-{{ active_claim.id }}"></canvas>
                                    </div>
                                </div>
                                
                                <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="pills-refutes-tab" data-bs-toggle="pill" href="#pills-refutes">
                                            Refutes <span class="badge bg-danger ms-1">{{ active_claim.evidences | count_occurrences("REFUTES", "relationship") }}</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="pills-supports-tab" data-bs-toggle="pill" href="#pills-supports">
                                            Supports <span class="badge bg-success ms-1">{{ active_claim.evidences | count_occurrences("SUPPORTS", "relationship") }}</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="pills-irrelevant-tab" data-bs-toggle="pill" href="#pills-irrelevant">
                                            Irrelevant <span class="badge bg-secondary ms-1">{{ active_claim.evidences | count_occurrences("IRRELEVANT", "relationship") }}</span>
                                        </a>
                                    </li>
                                </ul>
                                <div class="tab-content" id="pills-tabContent">
                                    <div class="tab-pane fade show active" id="pills-refutes">
                                        {% for evi in active_claim.evidences | filter_evidences("REFUTES", "relationship") %}
                                        <div class="border-start border-danger border-4 ps-3 mb-3">
                                            <p class="mb-1"><strong>Source:</strong> <a href="{{ evi.url }}" target="_blank">{{ evi.url | url_host }}</a></p>
                                            <p class="mb-1"><strong>Evidence:</strong> {{ evi.text }}</p>
                                            <small class="text-muted"><strong>Reasoning:</strong> {{ evi.reasoning }}</small>
                                        </div>
                                        {% else %}
                                        <p class="text-center text-muted mt-3">No refuting evidence found.</p>
                                        {% endfor %}
                                    </div>
                                    <div class="tab-pane fade" id="pills-supports">
                                        {% for evi in active_claim.evidences | filter_evidences("SUPPORTS", "relationship") %}
                                        <div class="border-start border-success border-4 ps-3 mb-3">
                                            <p class="mb-1"><strong>Source:</strong> <a href="{{ evi.url }}" target="_blank">{{ evi.url | url_host }}</a></p>
                                            <p class="mb-1"><strong>Evidence:</strong> {{ evi.text }}</p>
                                            <small class="text-muted"><strong>Reasoning:</strong> {{ evi.reasoning }}</small>
                                        </div>
                                        {% else %}
                                        <p class="text-center text-muted mt-3">No supporting evidence found.</p>
                                        {% endfor %}
                                    </div>
                                    <div class="tab-pane fade" id="pills-irrelevant">
                                        {% for evi in active_claim.evidences | filter_evidences("IRRELEVANT", "relationship") %}
                                        <div class="border-start border-secondary border-4 ps-3 mb-3">
                                            <p class="mb-1"><strong>Source:</strong> <a href="{{ evi.url }}" target="_blank">{{ evi.url | url_host }}</a></p>
                                            <p class="mb-1"><strong>Evidence:</strong> {{ evi.text }}</p>
                                            <small class="text-muted"><strong>Reasoning:</strong> {{ evi.reasoning }}</small>
                                        </div>
                                        {% else %}
                                        <p class="text-center text-muted mt-3">No irrelevant evidence found.</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="card">
                             <div class="card-body text-center">
                                <h5 class="card-title mt-2">No Verifiable Claims Found</h5>
                                <p class="card-text">The system did not find any factual claims to verify in the provided text.</p>
                                <p class="text-muted">This could be because the text is an opinion, a question, or too ambiguous.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="col-xl-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted mb-3">OVERALL FACTUALITY</h6>
                            {% set factuality = responses.summary.factuality %}
                            {% if factuality is number and factuality >= 0.75 %}
                                <h2 class="text-success mb-0">{{ "%.0f"|format(factuality * 100) }}% <small>Highly Factual</small></h2>
                            {% elif factuality is number and factuality <= 0.25 %}
                                <h2 class="text-danger mb-0">{{ "%.0f"|format(factuality * 100) }}% <small>Mostly False</small></h2>
                            {% elif factuality is number %}
                                <h2 class="text-warning mb-0">{{ "%.0f"|format(factuality * 100) }}% <small>Mixed</small></h2>
                            {% else %}
                                <h2 class="text-muted mb-0">{{ factuality }}</h2>
                            {% endif %}
                        </div>
                        <hr class="m-0">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col">
                                    <div class="fs-5 fw-bold">{{ responses.summary.num_claims }}</div>
                                    <div class="fs-12px">Detected</div>
                                </div>
                                <div class="col">
                                    <div class="fs-5 fw-bold text-success">{{ responses.summary.num_supported_claims }}</div>
                                    <div class="fs-12px">Supported</div>
                                </div>
                                <div class="col">
                                    <div class="fs-5 fw-bold text-danger">{{ responses.summary.num_refuted_claims }}</div>
                                    <div class="fs-12px">Refuted</div>
                                </div>
                                <div class="col">
                                    <div class="fs-5 fw-bold text-warning">{{ responses.summary.num_controversial_claims }}</div>
                                    <div class="fs-12px">Mixed</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-body">
                            <h5 class="card-title">Argumentation Graph (SAG)</h5>
                            <div id="sag-network" style="height: 350px; border: 1px solid #dee2e6;"></div>
                        </div>
                    </div>
                </div>
            </div>
		</div>

		<a href="#" data-toggle="scroll-to-top" class="btn-scroll-top fade"><i class="fa fa-arrow-up"></i></a>
	</div>

	<script src="{{ url_for('static', filename='js/vendor.min.js') }}"></script>
	<script src="{{ url_for('static', filename='js/app.min.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript">
        function convertUrlsToLinks (text) {
          const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
          return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        }

        function switchClaim (id) {
          window.location.href = "/shownClaim/" + id;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.claim-interactive').forEach((el) => {
                el.addEventListener('click', () => {
                const id = Number(el.getAttribute('data-claim-index'));
                if (!Number.isNaN(id)) {
                    switchClaim(id);
                }
                });
            });

            const allClaimsData = {{ responses.claim_detail | tojson | safe }};
            const sagData = {{ responses.sag | tojson | safe }};
            const activeClaim = allClaimsData[{{ shown_claim }}];
            if (activeClaim && activeClaim.evidences && activeClaim.evidences.length > 0) {
                const supportCount = activeClaim.evidences.filter(e => e.relationship === 'SUPPORTS').length;
                const refuteCount = activeClaim.evidences.filter(e => e.relationship === 'REFUTES').length;
                const irrelevantCount = activeClaim.evidences.length - supportCount - refuteCount;

                const ctx = document.getElementById('chart-' + activeClaim.id);
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Supports', 'Refutes', 'Irrelevant'],
                            datasets: [{
                                data: [supportCount, refuteCount, irrelevantCount],
                                backgroundColor: ['#198754', '#dc3545', '#6c757d'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                           responsive: true,
                           plugins: { legend: { display: false }, tooltip: { enabled: true } }
                        }
                    });
                }
            }

            if (sagData && sagData.nodes && sagData.nodes.length > 0) {
                const nodes = new vis.DataSet(sagData.nodes);
                const mappedEdges = sagData.edges.map(edge => ({
                    from: edge.source,
                    to: edge.target,
                    label: edge.label,
                    arrows: 'to',
                    color: { 
                        color: edge.label.toLowerCase() === 'attacks' ? '#dc3545' : '#198754',
                        highlight: edge.label.toLowerCase() === 'attacks' ? '#dc3545' : '#198754'
                    }
                }));
                const edges = new vis.DataSet(mappedEdges);

                const container = document.getElementById('sag-network');
                const data = { nodes: nodes, edges: edges };

                const options = {
                    nodes: {
                        shape: 'box', margin: 10,
                        font: { size: 14, color: '#333' },
                        color: { border: '#adb5bd', background: '#f8f9fa' }
                    },
                    edges: {
                        font: { align: 'top', color: '#6c757d' }
                    },
                    physics: { enabled: true, solver: 'barnesHut' },
                    interaction: { hover: true }
                };
                
                const network = new vis.Network(container, data, options);
            }

            const reportMarkdown = {{ responses.final_report | tojson | safe }};
            if (reportMarkdown) {
                document.getElementById('final-report-content').innerHTML = marked.parse(reportMarkdown);
            }

        });
    </script>
</body>
</html>